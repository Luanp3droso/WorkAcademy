@model WorkAcademy.Models.Usuario

@{
    ViewData["Title"] = "Perfil";
    var publicacoes = ViewBag.Publicacoes as List<WorkAcademy.Models.Publicacao>;
    var conexoes = ViewBag.Conexoes as List<WorkAcademy.Models.Conexao>;
    var certificados = ViewBag.Certificados as List<WorkAcademy.Models.Certificado>;

    var userEmail = User?.Identity?.IsAuthenticated == true
        ? User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value
        : null;
    var isMeuPerfil = userEmail != null && userEmail == Model.Email;
}

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />
<!-- Cropper.js CSS (CDN) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />

<style>
    .perfil-container {
        max-width: 1080px;
        margin: auto;
        font-family: 'Segoe UI', sans-serif;
    }

    .perfil-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        gap: 20px;
        background: #fff;
        border-bottom: 1px solid #eee;
        border-radius: 8px 8px 0 0;
    }

    .perfil-foto-wrapper {
        position: relative;
    }

    .foto-perfil {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
        cursor: zoom-in;
    }

    .foto-cam-icon {
        position: absolute;
        bottom: 0;
        right: 0;
        background: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ccc;
        font-size: 18px;
        color: #333;
        box-shadow: 0 0 4px rgba(0,0,0,0.2);
        cursor: pointer;
    }

    .perfil-nome-botoes {
        flex-grow: 1;
    }

    .btn-editar-perfil {
        font-size: 13px;
        padding: 5px 10px;
        background: transparent;
        border: 1px solid #007bff;
        color: #007bff;
        border-radius: 6px;
        text-decoration: none;
        transition: 0.2s ease;
    }

        .btn-editar-perfil:hover {
            background: #007bff;
            color: white;
        }

    .perfil-menu {
        background: #f9f9f9;
        padding: 12px 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 20px;
    }

        .perfil-menu a {
            text-decoration: none;
            font-weight: bold;
            color: #333;
            cursor: pointer;
        }

            .perfil-menu a.ativo {
                border-bottom: 2px solid #007bff;
            }

    .perfil-conteudo {
        padding: 30px 20px;
        background: #fafafa;
    }

    .aba {
        display: none;
    }

        .aba.ativa {
            display: block;
        }

    .card {
        background: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .area-publicacoes .post {
        background: white;
        padding: 16px;
        margin-bottom: 16px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .duas-colunas {
        display: flex;
        gap: 30px;
    }

    .coluna-esquerda {
        flex: 1;
    }

    .coluna-direita {
        flex: 2;
    }

    .foto-modal-bg {
        display: none;
        position: fixed;
        z-index: 9999;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.85);
        justify-content: center;
        align-items: center;
    }

        .foto-modal-bg img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            box-shadow: 0 0 10px black;
            cursor: zoom-out;
        }
</style>

<div class="perfil-container">

    @if (TempData["Sucesso"] != null)
    {
        <div class="alert alert-success text-center mt-3 mb-3" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            @TempData["Sucesso"]
        </div>
    }

    <div class="perfil-info">
        <div class="perfil-foto-wrapper">
            <img src="@(string.IsNullOrWhiteSpace(Model.FotoPerfil) ? "/img/usuarios/default.png" : Model.FotoPerfil)"
                 class="foto-perfil" id="fotoPerfilView" />

            @if (isMeuPerfil)
            {
                <form asp-action="AtualizarFoto" asp-controller="Usuario" method="post" enctype="multipart/form-data" id="formFotoPerfil">
                    <label class="foto-cam-icon" for="fotoPerfilInput">
                        <i class="bi bi-camera-fill"></i>
                    </label>
                    <input type="file" name="fotoPerfil" id="fotoPerfilInput" style="display:none" accept="image/*" />
                </form>
            }
        </div>

        <div class="perfil-nome-botoes">
            <h2>@Model.NomeCompleto</h2>
            <span class="conexoes">@conexoes?.Count() conexões</span>
        </div>

        @if (isMeuPerfil)
        {
            <a asp-controller="Usuario" asp-action="EditarPerfil" class="btn-editar-perfil">✏️ Editar</a>
        }
    </div>

    <div class="perfil-menu">
        <a class="aba-link ativo" data-target="sobre">Sobre</a>
        <a class="aba-link" data-target="conexoes">Conexões</a>
        <a class="aba-link" data-target="certificados">Certificados</a>
    </div>

    <div class="perfil-conteudo">
        <!-- Aba SOBRE + PUBLICAÇÕES -->
        <div id="sobre" class="aba ativa">
            <div class="duas-colunas">
                <div class="coluna-esquerda">
                    <div class="card">
                        <h5>Apresentação</h5>
                        <p><strong>Biografia:</strong> @Model.Biografia</p>
                        <p><strong>Endereço:</strong> @Model.Endereco</p>
                        <p><strong>Celular:</strong> @Model.Celular</p>
                        <p><strong>Área de Interesse:</strong> @Model.AreaInteresse</p>
                        <p><strong>Data de Cadastro:</strong> @Model.DataCadastro.ToShortDateString()</p>
                    </div>
                </div>
                <div class="coluna-direita">
                    <div class="card area-publicacoes">
                        <h5>Publicações</h5>
                        @if (publicacoes != null && publicacoes.Any())
                        {
                            foreach (var post in publicacoes)
                            {
                                <div class="post">
                                    <p>@post.Conteudo</p>
                                    <small>@post.DataCriacao.ToShortDateString()</small>
                                </div>
                            }
                        }
                        else
                        {
                            <p>Nenhuma publicação encontrada.</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba Conexões -->
        <div id="conexoes" class="aba">
            <div class="card">
                <h5 class="mb-3">Minhas Conexões</h5>

                @if (conexoes != null && conexoes.Any())
                {
                    @foreach (var c in conexoes)
                    {
                        var amigo = c.UsuarioId == Model.Id ? c.ConectadoCom : c.Usuario;
                        if (amigo != null)
                        {
                            <div class="d-flex align-items-center justify-content-between p-2 mb-2 bg-light rounded shadow-sm" style="font-size: 14px;">
                                <div class="d-flex align-items-center">
                                    <img src="@(!string.IsNullOrEmpty(amigo.FotoPerfil) ? amigo.FotoPerfil : "/img/usuarios/default.png")"
                                         class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;" />
                                    <span><strong>@amigo.NomeCompleto</strong></span>
                                </div>
                                <div class="d-flex gap-1">
                                    <a href="/Usuario/Ver/@amigo.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-person-lines-fill"></i>
                                    </a>
                                    @if (isMeuPerfil)
                                    {
                                        <form method="post" asp-action="Desconectar" asp-controller="Usuario">
                                            <input type="hidden" name="usuarioId" value="@Model.Id" />
                                            <input type="hidden" name="conectadoComId" value="@amigo.Id" />
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        </form>
                                    }
                                </div>
                            </div>
                        }
                    }
                }
                else
                {
                    <p>Nenhuma conexão encontrada.</p>
                }
            </div>
        </div>

        <!-- Aba Certificados -->
        <div id="certificados" class="aba">
            <div class="card">
                <h5>Certificados</h5>
                @if (certificados != null && certificados.Any())
                {
                    <ul>
                        @foreach (var c in certificados)
                        {
                            <li>
                                <strong>@c.Curso.Nome</strong> — @c.DataConclusao.ToShortDateString()
                                [<a href="@c.CaminhoArquivo" target="_blank">Ver certificado</a>]
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>Você ainda não concluiu nenhum curso.</p>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal de visualização da foto (zoom simples) -->
<div id="fotoModal" class="foto-modal-bg" onclick="this.style.display='none'">
    <img id="fotoModalImg" src="" />
</div>

<!-- Modal de recorte (Cropper.js) -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ajustar Foto de Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="imageToCrop" style="max-width: 100%; max-height: 70vh;" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnCrop">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Cropper.js JS (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<!-- Bootstrap JS (necessário para o modal; se já está no _Layout, pode remover) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Abas
    const links = document.querySelectorAll(".aba-link");
    const abas = document.querySelectorAll(".aba");
    links.forEach(link => {
        link.addEventListener("click", () => {
            links.forEach(l => l.classList.remove("ativo"));
            link.classList.add("ativo");
            abas.forEach(aba => {
                aba.classList.remove("ativa");
                if (aba.id === link.dataset.target) aba.classList.add("ativa");
            });
        });
    });

    // Zoom da foto
    const fotoPerfilView = document.getElementById("fotoPerfilView");
    fotoPerfilView.addEventListener("click", function () {
        const modal = document.getElementById("fotoModal");
        const img = document.getElementById("fotoModalImg");
        img.src = this.src;
        modal.style.display = "flex";
    });

    // Recorte com Cropper.js
    const inputFoto = document.getElementById("fotoPerfilInput");
    let cropper;

    inputFoto?.addEventListener("change", function (e) {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
            const img = document.getElementById("imageToCrop");
            img.src = event.target.result;

            const modalEl = document.getElementById("cropperModal");
            const modal = new bootstrap.Modal(modalEl);
            modal.show();

            modalEl.addEventListener('shown.bs.modal', () => {
                cropper = new Cropper(img, {
                    aspectRatio: 1,           // quadrado
                    viewMode: 2,
                    dragMode: 'move',
                    autoCropArea: 1,
                    background: false
                });
            }, { once: true });

            modalEl.addEventListener('hidden.bs.modal', () => {
                cropper?.destroy();
                cropper = null;
                inputFoto.value = "";       // reseta input
            }, { once: true });
        };
        reader.readAsDataURL(file);
    });

    document.getElementById("btnCrop").addEventListener("click", function () {
        if (!cropper) return;

        // Gera canvas cortado (ajuste o tamanho final aqui)
        const canvas = cropper.getCroppedCanvas({
            width: 400,
            height: 400,
            fillColor: '#fff'
        });

        canvas.toBlob(blob => {
            const file = new File([blob], "foto_cortada.png", { type: "image/png" });
            const formData = new FormData();
            formData.append("fotoPerfil", file);

            fetch("/Usuario/AtualizarFoto", {
                method: "POST",
                body: formData
            }).then(res => {
                if (res.ok) location.reload();
                else alert("Erro ao salvar imagem.");
            });
        });

        const modal = bootstrap.Modal.getInstance(document.getElementById("cropperModal"));
        modal.hide();
    });
</script>
