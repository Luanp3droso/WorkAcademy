@model List<WorkAcademy.Controllers.UsuarioComRolesViewModel>

@{
    ViewData["Title"] = "Gerenciar Usuários";
}

<h2>Gerenciar Usuários</h2>

<!-- MENSAGENS -->
@if (TempData["Sucesso"] != null)
{
    <div class="alert alert-success">@TempData["Sucesso"]</div>
}
@if (TempData["Erro"] != null)
{
    <div class="alert alert-danger">@TempData["Erro"]</div>
}

<!-- FORMULÁRIO DE FILTRO -->
<form asp-action="Usuarios" method="get" class="row mb-4">
    <div class="col-md-4">
        <label for="filtroEmail" class="form-label">Buscar por email:</label>
        <input type="text" id="filtroEmail" name="filtroEmail" value="@Context.Request.Query["filtroEmail"]" class="form-control" placeholder="Ex: exemplo@email.com" />
    </div>

    <div class="col-md-3">
        <label for="filtroRole" class="form-label">Função:</label>
        <select id="filtroRole" name="filtroRole" class="form-select">
            <option value="Todos" selected="@(Context.Request.Query["filtroRole"] == "Todos" || string.IsNullOrEmpty(Context.Request.Query["filtroRole"]))">Todas</option>
            <option value="User" selected="@(Context.Request.Query["filtroRole"] == "User")">User</option>
            <option value="Empresa" selected="@(Context.Request.Query["filtroRole"] == "Empresa")">Empresa</option>
            <option value="Admin" selected="@(Context.Request.Query["filtroRole"] == "Admin")">Admin</option>
        </select>
    </div>

    <div class="col-md-3">
        <label for="filtroStatus" class="form-label">Status:</label>
        <select id="filtroStatus" name="filtroStatus" class="form-select">
            <option value="Todos" selected="@(Context.Request.Query["filtroStatus"] == "Todos" || string.IsNullOrEmpty(Context.Request.Query["filtroStatus"]))">Todos</option>
            <option value="Ativo" selected="@(Context.Request.Query["filtroStatus"] == "Ativo")">Ativo</option>
            <option value="Bloqueado" selected="@(Context.Request.Query["filtroStatus"] == "Bloqueado")">Bloqueado</option>
        </select>
    </div>

    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
</form>

<!-- TABELA DE USUÁRIOS -->
<table class="table table-bordered table-hover mt-4">
    <thead class="table-dark">
        <tr>
            <th>Email</th>
            <th>Funções</th>
            <th>Status</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var usuario in Model)
        {
            <tr>
                <td>@usuario.Email</td>
                <td>@string.Join(", ", usuario.Roles)</td>
                <td>
                    @if (usuario.Bloqueado)
                    {
                        <span class="text-danger">Bloqueado</span>
                    }
                    else
                    {
                        <span class="text-success">Ativo</span>
                    }
                </td>
                <td>
                    <!-- Atribuir Role -->
                    <form asp-action="AtribuirRole" method="post" class="d-inline">
                        <input type="hidden" name="userId" value="@usuario.Id" />
                        <select name="role" class="form-select d-inline w-auto">
                            <option value="User">User</option>
                            <option value="Empresa">Empresa</option>
                            <option value="Admin">Admin</option>
                        </select>
                        <button type="submit" class="btn btn-sm btn-primary">Atribuir</button>
                    </form>

                    <!-- Bloquear/Desbloquear -->
                    @if (!usuario.Bloqueado)
                    {
                        <form asp-action="BloquearUsuario" method="post" class="d-inline ms-1">
                            <input type="hidden" name="userId" value="@usuario.Id" />
                            <button type="submit" class="btn btn-sm btn-danger">Bloquear</button>
                        </form>
                    }
                    else
                    {
                        <form asp-action="DesbloquearUsuario" method="post" class="d-inline ms-1">
                            <input type="hidden" name="userId" value="@usuario.Id" />
                            <button type="submit" class="btn btn-sm btn-success">Desbloquear</button>
                        </form>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
