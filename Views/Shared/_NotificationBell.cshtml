@* Views/Shared/_NotificationBell.cshtml *@
<div class="nav-item dropdown me-2">
    <a class="nav-link position-relative text-white" href="#" id="notificationBell" role="button"
       data-bs-toggle="dropdown" aria-expanded="false" aria-label="Notificações">
        <i class="bi bi-bell fs-5"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none"
              id="notifBadge"></span>
    </a>

    <ul class="dropdown-menu dropdown-menu-end shadow-lg p-0"
        aria-labelledby="notificationBell" style="width: 360px; max-width: 90vw;">
        <li class="px-3 py-2 d-flex justify-content-between align-items-center border-bottom">
            <strong>Notificações</strong>
            <button class="btn btn-sm btn-link text-decoration-none" id="markAllReadBtn" type="button">
                Marcar tudo como lido
            </button>
        </li>

        <!-- Loading (oculto inicialmente) -->
        <li id="notifLoading" class="p-3 text-center text-muted d-none">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>Carregando...
        </li>

        <!-- EMPTY STATE -->
        <li id="notifEmpty" class="p-3 text-center text-muted d-none">
            Não há novas notificações
        </li>

        <!-- LISTA DE ITENS -->
        <li class="p-0 d-none" id="notifItemsWrapper">
            <ul class="list-unstyled mb-0" id="notifList"></ul>
        </li>

        <li class="p-2 text-center border-top">
            <a class="btn btn-link text-decoration-none" asp-controller="Notifications" asp-action="Index">Ver todas</a>
        </li>
    </ul>
</div>

<script>
    (function () {
        const badge = document.getElementById('notifBadge');
        const list = document.getElementById('notifList');
        const itemsWrapper = document.getElementById('notifItemsWrapper');
        const loading = document.getElementById('notifLoading');
        const empty = document.getElementById('notifEmpty');
        const bell = document.getElementById('notificationBell');
        const markAllBtn = document.getElementById('markAllReadBtn');

        async function getJson(url) {
            try {
                const r = await fetch(url, { credentials: 'same-origin' });
                if (!r.ok) return null;
                return await r.json();
            } catch { return null; }
        }

        function escapeHtml(s) {
            return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
        }

        function renderItem(n) {
            const icon = n.icon || 'bi-bell';
            const time = n.createdAt ? new Date(n.createdAt) : new Date();
            const since = time.toLocaleString();
            const title = escapeHtml(n.title);
            const message = n.message ? `<div class="text-muted small">${escapeHtml(n.message)}</div>` : '';
            const cta = n.url ? `<div class="ms-2"><a href="${n.url}" class="btn btn-sm btn-outline-primary">Abrir</a></div>` : '';
            return `
                <li class="p-3 border-bottom">
                  <div class="d-flex">
                    <div class="me-3"><i class="bi ${icon} fs-4"></i></div>
                    <div class="flex-grow-1">
                      <div class="fw-semibold">${title}</div>
                      ${message}
                      <div class="text-muted small">${since}</div>
                    </div>
                    ${cta}
                  </div>
                </li>`;
        }

        async function refreshCount() {
            const data = await getJson('/Notifications/Count');
            const count = data?.count ?? 0;
            if (count > 0) { badge.textContent = count; badge.classList.remove('d-none'); }
            else { badge.textContent = ''; badge.classList.add('d-none'); }
        }

        function showLoading() { loading.classList.remove('d-none'); empty.classList.add('d-none'); itemsWrapper.classList.add('d-none'); }
        function showEmpty()   { loading.classList.add('d-none');    empty.classList.remove('d-none'); itemsWrapper.classList.add('d-none'); }
        function showItems(h)  { loading.classList.add('d-none');    empty.classList.add('d-none');    itemsWrapper.classList.remove('d-none'); list.innerHTML = h; }

        async function loadLatest() {
            showLoading();
            const items = await getJson('/Notifications/Latest?take=10');
            if (!items || items.length === 0) return showEmpty();
            showItems(items.map(renderItem).join(''));
        }

        refreshCount();
        setInterval(refreshCount, 30000);
        bell?.addEventListener('show.bs.dropdown', loadLatest);
        bell?.addEventListener('click', loadLatest);
        markAllBtn?.addEventListener('click', async (e) => {
            e.preventDefault();
            await fetch('/Notifications/MarkAllRead', { credentials: 'same-origin' });
            await refreshCount();
            await loadLatest();
        });
    })();
</script>
